---
layout: post
title: è¯†åˆ« Emoji è¡¨æƒ…
date: 2019-01-01 20:36:24
---


åœ¨å¤„ç†ç”¨æˆ·è¾“å…¥çš„å†…å®¹æ—¶å€™ï¼Œæœ‰äº›åœºæ™¯ä¸å¸Œæœ›è¾“å…¥ emojiï¼Œåœ¨ iOS ä¸­å¦‚ä½•æ£€æµ‹ emojiï¼Ÿç»“åˆç½‘ä¸Šçš„ä¸€äº›èµ„æ–™ï¼Œæˆ‘æ€»ç»“ä¸€ä¸‹è¯†åˆ« emoji çš„æ–¹æ³•ï¼Œåœ¨ä»‹ç» emoji ä¹‹å‰å…ˆäº†è§£ä¸‹å­—ç¬¦é›†å’Œå­—ç¬¦ç¼–ç ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ã€‚

### Unicode å­—ç¬¦é›†

Unicode æ ‡å‡†ä¸ºä¸–ç•Œä¸Šå‡ ä¹æ‰€æœ‰çš„[^1]ä¹¦å†™ç³»ç»Ÿé‡Œæ‰€ä½¿ç”¨çš„æ¯ä¸€ä¸ªå­—ç¬¦æˆ–ç¬¦å·å®šä¹‰äº†ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—ã€‚è¿™ä¸ªæ•°å­—å«åšç ç‚¹ï¼ˆcode pointsï¼‰ï¼Œä»¥ U+xxxx è¿™æ ·çš„æ ¼å¼å†™æˆï¼Œæ ¼å¼é‡Œçš„ xxxx ä»£è¡¨å››åˆ°å…­ä¸ªåå…­è¿›åˆ¶çš„æ•°ã€‚

æœ€åˆï¼ŒUnicode ç¼–ç æ˜¯è¢«è®¾è®¡ä¸º 16 ä½çš„ï¼Œæä¾›äº† 65,536 ä¸ªå­—ç¬¦çš„ç©ºé—´ã€‚åæ¥ï¼Œè€ƒè™‘åˆ°è¦ç¼–ç å†å²ä¸Šçš„æ–‡å­—ä»¥åŠä¸€äº›å¾ˆå°‘ä½¿ç”¨çš„æ—¥æœ¬æ±‰å­—å’Œä¸­å›½æ±‰å­—ï¼ŒUnicode ç¼–ç æ‰©å±•åˆ°äº† 21 ä½ï¼ˆä» U+0000 åˆ° U+10FFFFï¼‰ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨æ¥è§¦åˆ°çš„ Unicode æ˜¯ 21 ä½çš„ç¼–ç ã€‚

ç¼–ç ç©ºé—´è¢«åˆ†æˆ 17 ä¸ªå¹³é¢ï¼ˆplaneï¼‰ï¼Œæ¯ä¸ªå¹³é¢æœ‰ 65,536 ä¸ªå­—ç¬¦ã€‚

![](../../../images/UnicodePlanes.jpg)

0 å·å¹³é¢å«åšã€ŒåŸºæœ¬å¤šæ–‡ç§å¹³é¢ã€ï¼ˆBasic Multilingual Plane, BMPï¼‰ï¼Œæ¶µç›–äº†å‡ ä¹æ‰€æœ‰ä½ èƒ½é‡åˆ°çš„å­—ç¬¦ã€‚å…¶å®ƒå¹³é¢å«åšè¡¥å……å¹³é¢ï¼Œå¤§å¤šæ˜¯ç©ºçš„ã€‚

### UTF ç¼–ç 

Unicode å®šä¹‰äº†å­—ç¬¦åˆ°ç ç‚¹çš„æ˜ å°„ï¼Œå…·ä½“å¦‚ä½•åœ¨è®¡ç®—æœºä¸Šå­˜å‚¨ï¼Œå°±éœ€è¦ä½¿ç”¨ UTF ï¼ˆUnicode Transformation Formatsï¼Œç®€ç§° UTFï¼‰ç¼–ç äº†ã€‚å¸¸è§çš„ç¼–ç æ ¼å¼æœ‰ UIF-32ã€UTF-16 å’Œ UTF-8ï¼Œçœ‹åå­—å°±çŸ¥é“å®ƒä»¬å«ä¹‰ï¼Œ32ã€16ã€8 è¡¨ç¤ºç”¨äºå­˜å‚¨çš„é•¿åº¦ã€‚ä½¿ç”¨ 32 ä½å­˜å‚¨ä¸€ä¸ªç ç‚¹ï¼ˆç ç‚¹é•¿åº¦ 21 ä½ï¼‰å¤ªæµªè´¹ç©ºé—´äº†ï¼Œç°å®ä¸­å¾ˆå°‘ä½¿ç”¨ã€‚UTF-16 ä½¿ç”¨ 16 ä½å›ºå®šé•¿åº¦çš„ç å…ƒï¼ŒBMP çš„èŒƒå›´åœ¨ 0000-FFFF ä¹‹é—´ï¼Œä¸€ä¸ªç ç‚¹ç›´æ¥ä¸ä¸€ä¸ªç å…ƒç›¸æ˜ å°„ï¼Œä½¿ç”¨ UTF-16 æ¯” UTF-32 èŠ‚çœä¸€åŠçš„ç©ºé—´ã€‚å…¶å®ƒå¹³é¢çš„å­—ç¬¦è¶…è¿‡äº† 16 ä½çš„è¡¨ç¤ºèŒƒå›´ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ä¸ª UTF-16 ç å…ƒç»„åˆèµ·æ¥è¡¨ç¤ºï¼Œå«åšä»£ç†å¯¹ï¼ˆsurrogate pairï¼‰ã€‚NSString ä½¿ç”¨çš„å°±æ˜¯ UTF-16 ç¼–ç å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»ã€‚UTF-8 çš„ç”¨é€”æ›´å¹¿æ³›ï¼Œå·²ç»æ˜¯æ–‡ä»¶æ ¼å¼ã€ç½‘ç»œåè®®ä»¥åŠ Web API é¢†åŸŸé‡Œäº‹å®ä¸Šçš„æ ‡å‡†äº†ï¼Œå®ƒä¸ emoji çš„å…³ç³»ä¸å¤§ï¼Œè¿™é‡Œä¸åšè¯¦ç»†ä»‹ç»äº†ã€‚

###NSString å­˜å‚¨

NSString å¯¹è±¡ä»£è¡¨çš„å…¶å®æ˜¯ç”¨ UTF-16 ç¼–ç çš„ç å…ƒç»„æˆçš„æ•°ç»„ã€‚ç›¸åº”åœ°ï¼Œlength æ–¹æ³•çš„è¿”å›å€¼ä¹Ÿæ˜¯å­—ç¬¦ä¸²åŒ…å«çš„ç å…ƒä¸ªæ•°ï¼ˆè€Œä¸æ˜¯å­—ç¬¦ä¸ªæ•°ï¼‰ã€‚è¯•ç€æ‰“å° ğŸ˜›(U+1F61B) çš„é•¿åº¦ï¼Œè¾“å‡º 2ã€‚å› ä¸º U+1F61B è¶…å‡ºäº† BMP çš„èŒƒå›´ï¼Œéœ€è¦ä½¿ç”¨ä¸¤ä¸ª UTF-16 ç å…ƒç»„åˆæˆä»£ç†å¯¹è¡¨ç¤ºã€‚

```objc
 NSString *emoji = @"ğŸ˜›";
 NSLog(@"emoji.length: %@", @(emoji.length)); // emoji.length: 2
```

åœ¨å·¥ä½œä¸­ç»å¸¸ä¼šé‡åˆ°é™åˆ¶ç”¨æˆ·è¾“å…¥å­—ç¬¦ä¸ªæ•°çš„éœ€æ±‚ï¼Œæ¯”å¦‚è¦æ±‚ç”¨æˆ·åæœ€é•¿ä¸è¶…è¿‡ 10 ä¸ªå­—ç¬¦ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨ length åˆ¤æ–­å°±å¯ä»¥äº†ï¼Œå¦‚æœç”¨æˆ·è¾“å…¥äº† emoji è¡¨æƒ…ï¼Œä½¿ç”¨ length åˆ¤æ–­å¯èƒ½å°±ä¸ç¬¦åˆè¦æ±‚äº†ã€‚ç”¨æˆ·è¾“å…¥äº† 3 ä¸ª ğŸ‘¨ğŸ»â€âš•ï¸ï¼ˆ1F468 1F3FB 200D 2695 FE0Fï¼‰ï¼Œæ‰“å°å‡ºlength çš„é•¿åº¦æ˜¯ 21ï¼ˆæ¯ä¸ª ğŸ‘¨ğŸ»â€âš•ï¸ é•¿åº¦ä¸º: 2 + 2 + 1 + 1 + 1ï¼‰ï¼Œå·²ç»è¶…è¿‡ 10 ï¼Œæç¤ºç”¨è¶…é•¿äº†è‚¯å®šä¸åˆç†ã€‚å¦‚ä½•åˆ¤æ–­å­—ç¬¦é•¿åº¦å‘¢ï¼Ÿ`enumerateSubstringsInRange:options:usingBlock:` æ–¹æ³•ä»¥å­—ç¬¦ä¸ºå•ä½è¿›è¡Œéå†ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å¯ä»¥ç»Ÿè®¡å­—ç¬¦çœŸæ­£çš„é•¿åº¦ã€‚

```objc
NSString *emoji = @"ğŸ‘¨ğŸ»â€âš•ï¸ğŸ‘¨ğŸ»â€âš•ï¸ğŸ‘¨ğŸ»â€âš•ï¸";
NSLog(@"length: %@", @(emoji.length)); // length: 21

__block NSUInteger realLength = 0;
[emoji enumerateSubstringsInRange:NSMakeRange(0, emoji.length) options:NSStringEnumerationByComposedCharacterSequences usingBlock:^(NSString * _Nullable substring, NSRange substringRange, NSRange enclosingRange, BOOL * _Nonnull stop) {
    NSLog(@"==> subRange:%@, subStr:%@", NSStringFromRange(substringRange), substring);
    realLength += 1;
}];
NSLog(@"realLength: %@", @(realLength)); // realLength: 3
```
###emoji

ä»[ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Emoji)äº†è§£åˆ°ç›®å‰ emoji å·²ç»æ›´æ–°åˆ° [11.0](https://unicode.org/Public/emoji/11.0/)ï¼Œæ€»å…±æœ‰ 1212 ä¸ªå•ç ç‚¹çš„è¡¨æƒ…ï¼Œè¿˜æœ‰æ›´å¤šçš„è¡¨æƒ…å¯ä»¥é€šè¿‡å¤šä¸ªç ç‚¹ç»„åˆè€Œæˆã€‚å…·ä½“çš„ç»„åˆæ–¹å¼æœ‰ï¼š

* Emoji\_Keycap_Sequence: æ™®è°ƒçš„å­—ç¬¦ `#*0123456789` åŠ ä¸Š FE0F 20E3 å°±å˜æˆäº† #ï¸âƒ£*ï¸âƒ£0ï¸âƒ£1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£4ï¸âƒ£5ï¸âƒ£6ï¸âƒ£7ï¸âƒ£8ï¸âƒ£9ï¸âƒ£ã€‚
* Emoji\_Flag_Sequence: å›½æ——è¡¨æƒ…ï¼Œè¿™ç±» emoji ä¸²æ˜¯é€šè¿‡ä¸¤ä¸ªåœ°åŸŸæŒ‡ç¤ºç¬¦ï¼ˆregional_indicatorï¼‰ç»„åˆçš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ä¸ªå›½å®¶çš„å›½æ——ã€‚å¦‚ ğŸ‡¿ğŸ‡¼(1F1FF 1F1FC)ï¼Œæ€»å…± 258 ä¸ªã€‚
* Emoji\_Modifier_Sequence: ä¸åŒè‚¤è‰²çš„è¡¨æƒ…ï¼Œå¦‚ â˜ï¸(261D) åŠ ä¸Š 1F3FF å°±å˜æˆäº† â˜ğŸ¿(261D 1F3FF)ï¼Œè¿™ç±»ä¸åŒè‚¤è‰²çš„è¡¨æƒ…æœ‰ 530 ä¸ªã€‚
* Emoji\_ZWJ_Sequence: é€šè¿‡ ZWJ å­—ç¬¦ï¼ˆU+200Dï¼Œ Zero Width Joinerï¼‰å°†åŸºæœ¬ emoji å­—ç¬¦æˆ– Emoji\_Modifier_Sequenceè¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„ emoji è¡¨ç¤ºæ ·å¼ï¼Œå¦‚ ğŸ‘¨â€â¤ï¸â€ğŸ‘¨(1F468 200D 2764 FE0F 200D 1F468) ç”± ğŸ‘¨(1F468) + â¤ï¸(2764 FE0F) + ğŸ‘¨(1F468) ç»„åˆè€Œæˆã€‚è¿™è¡¨æƒ…æ˜¯è¡¨ç¤ºä¸€å¯¹åŸºå‹ä¹ˆï¼Ÿ
* Emoji\_Tag_Sequence: åªæœ‰ä¸‰ä¸ª ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ã€ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ã€ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿ã€‚
* Emoji\_presentation_sequence: å³ç”±åŸºæœ¬ emoji å­—ç¬¦åŠ ä¸Š U+FE0F ç»„åˆè€Œæˆ emoji åºåˆ—ä¸²ã€‚ä¾‹å¦‚ â¤ï¸(U+26A1 U+FE0F)ã€‚

###è¯†åˆ«å­—ç¬¦ä¸²ä¸­çš„ emoji

[emoji-data.txt](https://unicode.org/Public/emoji/11.0/emoji-data.txt) çš„ç¬¬ä¸€ä¸ªè¡¨æ ¼ä¸­åŒ…å«äº†æ‰€æœ‰çš„å•ç ç‚¹ï¼Œæ€»æ•°æ˜¯ 1250ï¼Œé™¤å» `#*`ã€`0-9`å’Œ `a-z` æ­£å¥½ 1212 ä¸ªã€‚å¤šç ç‚¹ emoji ä¹Ÿæ˜¯ç”±å•ç ç‚¹ emoji è¿½åŠ ä¸€äº›ç‰¹æ®Šå­—ç¬¦ç»„åˆè€Œæˆï¼Œæ‰€ä»¥åªè¦å­—ç¬¦çš„ç¬¬ä¸€ä¸ªç ç‚¹åœ¨è¿™ä¸ªè¡¨æ ¼ç½—åˆ—çš„ç ç‚¹èŒƒå›´å†…ï¼Œå°±å¯ä»¥åˆ¤å®šå®ƒæ˜¯ emojiã€‚

**ç¬¬ä¸€æ­¥**ï¼Œæå–è¡¨æ ¼ä¸­çš„ç ç‚¹ã€‚æˆ‘ç”¨ Python å†™äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬æ ¼å¼åŒ–ç ç‚¹èŒƒå›´ï¼Œè¾“å‡ºä¸€ä¸ªæ•°ç»„å¤åˆ¶åˆ° OC ä»£ç ä¸­ä½¿ç”¨ã€‚

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import os

# ä½¿ç”¨æ–¹æ³•ï¼Œ python3 getEmojiData.py emoji-data.txt emoji-all-data.txt

readPath = os.path.join(os.path.abspath('.'), sys.argv[1])

resultStr = ''
with open(readPath, 'r') as f:
    for line in f.readlines():
        codeStr = line.partition(';')[0]
        if len(codeStr.rstrip()) == 0:
            continue
        pointList = codeStr.rstrip().split('..')
        formatPair = ''
        if len(pointList) == 1:
            formatPair = '{0x%s, 0x%s},' % (pointList[0], pointList[0])
        else:
            formatPair = '{0x%s, 0x%s},' % (pointList[0], pointList[1])
        resultStr = resultStr + '\n' + formatPair

writePath = os.path.join(os.path.abspath('.'), sys.argv[2])
with open(writePath, 'w') as f:
    f.write(resultStr)
```

åœ¨ OC ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

```objc
typedef struct {
    uint32_t start;
    uint32_t end;
} CodePair;

static CodePair CodePairList[] = {
    {0x00A9, 0x00A9},
    {0x00AE, 0x00AE},
    {0x203C, 0x203C},
    xxx
    
   };
```

**ç¬¬äºŒæ­¥**ï¼Œéå†å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ï¼Œæå–å­—ç¬¦çš„ç¬¬ä¸€ä¸ªç ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨èŒƒå›´å†…ã€‚è¦åŒºåˆ†ä¸¤ç§æƒ…å†µï¼Œemoji æ˜¯å•ç ç‚¹çš„ï¼Œå¦‚ Â©ï¸(U+00A9)ï¼Œç›´æ¥ç”¨ `characterAtIndex` å–ç ç‚¹ï¼›å¤§éƒ¨åˆ† emoji çš„ç ç‚¹æ•° >= 2ï¼Œç›´æ¥ä½¿ç”¨ `characterAtIndex` å°±ä¸è¡Œäº†ã€‚ä¾‹å¦‚ğŸ˜€(1F600)ï¼Œæ‰“å°å‡ºæ¥å¾—ç»“æœæ˜¯ï¼š

```objc
NSString *emoji = @"ğŸ˜€";
NSLog(@"%x, %x", [emoji characterAtIndex:0], [emoji characterAtIndex:1]); // d83d, de00
```
Unicode ä¸­æœ‰ 17 ä¸ªå¹³é¢ï¼Œåœ¨ç¬¬ 0 å¹³é¢ä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ä»£ç†åŒºåŸŸï¼Œä¸è¡¨ç¤ºä»»ä½•å­—ç¬¦ï¼Œåªç”¨äºæŒ‡å‘ç¬¬ 1 åˆ°ç¬¬ 16 ä¸ªå¹³é¢ä¸­çš„å­—ç¬¦ï¼Œè¿™æ®µåŒºåŸŸæ˜¯ï¼šD800â€”DFFF.ã€‚å…¶ä¸­ 0xD800â€”0xDBFF æ˜¯å‰å¯¼ä»£ç†(lead surrogates)ï¼Œ0xDC00â€”0xDFFF æ˜¯åå°¾ä»£ç†(trail surrogates)ã€‚å…·ä½“çš„å…¬å¼ï¼š`0x10000 + (å‰å¯¼-0xD800) * 0x400 + (åå¯¼-0xDC00) = utf-16ç¼–ç `

```objc
NSString *emoji = @"ğŸ˜€";
const unichar hs = [emoji characterAtIndex:0];
if (0xd800 <= hs && hs <= 0xdbff) {
    if (emoji.length > 1) {
        const unichar ls = [emoji characterAtIndex:1];
        const int uc = ((hs - 0xd800) * 0x400) + (ls - 0xdc00) + 0x10000;
        NSLog(@"%x", uc); // 1f600
    }
}
```




####å‚è€ƒæ–‡æ¡£
* [objccn.io: NSString ä¸ Unicode](https://objccn.io/issue-9-1/)
* [ä¸€ä¸ªå®‰å“åŒå­¦æ€»ç»“çš„: Emoji è¯†åˆ«ä¸è¿‡æ»¤](https://mupceet.com/2018/07/emoji-distinguish&filter/)
* [emoji/11.0](https://unicode.org/Public/emoji/11.0/)
* [Emojiï¼Œæ²¡æƒ³åˆ°ä½ æ˜¯è¿™æ ·çš„...](https://www.jianshu.com/p/9682f8ce1260)
